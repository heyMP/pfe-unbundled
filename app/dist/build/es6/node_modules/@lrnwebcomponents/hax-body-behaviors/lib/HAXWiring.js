/**
 * Copyright 2018 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{SimpleFields}from"../../simple-fields/simple-fields.js";import{HaxSchematizer,HaxElementizer}from"./HAXFields.js";export class HAXWiring{constructor(){this.haxProperties={canScale:!1,canPosition:!1,canEditSource:!1,settings:{quick:[],configure:[],advanced:[]},wipeSlot:{}},this.pathFromUrl=url=>url.substring(0,url.lastIndexOf("/")+1),this.setup=(props,tag="",context=this)=>(void 0!==this.tagName&&(tag=this.tagName.toLowerCase()),window.addEventListener("hax-store-ready",this._haxStoreReady.bind(this)),void 0!==window.HaxStore&&null!=window.HaxStore.instance&&window.HaxStore.ready?this.setHaxProperties(props,tag,context,!0):this.setHaxProperties(props,tag,context,!1)),this._haxStoreReady=e=>{if(e.detail&&void 0!==this.tagName&&void 0!==this.haxProperties){let tag=this.tagName,props=this.haxProperties,context=this;if(""!=tag&&void 0===window.HaxStore){const evt=new CustomEvent("hax-register-properties",{bubbles:!0,composed:!0,cancelable:!0,detail:{tag:tag.toLowerCase(),properties:props,polymer:!1}});context.dispatchEvent(evt)}else if(""!=tag&&void 0===window.HaxStore.instance.elementList[tag.toLowerCase()]){const evt=new CustomEvent("hax-register-properties",{bubbles:!0,composed:!0,cancelable:!0,detail:{tag:tag.toLowerCase(),properties:props}});context.dispatchEvent(evt)}else if(void 0!==this.tagName&&void 0===window.HaxStore.instance.elementList[this.tagName.toLowerCase()]){const evt=new CustomEvent("hax-register-properties",{bubbles:!0,composed:!0,cancelable:!0,detail:{tag:this.tagName.toLowerCase(),properties:props}});context.dispatchEvent(evt)}}},this.setHaxProperties=(props={},tag="",context=document,isReady=!1)=>{if(void 0===props.api&&(props.api="1"),"1"==props.api){if(void 0===props.canPosition&&(props.canPosition=!0),void 0===props.canScale&&(props.canScale=!0),void 0===props.canEditSource&&(props.canEditSource=!1),void 0===props.gizmo)props.gizmo=!1;else if(void 0!==props.gizmo.iconLib){const basePath=this.pathFromUrl(decodeURIComponent(import.meta.url));import(`${basePath}../../../${props.gizmo.iconLib}`)}if(void 0!==props.settings){void 0===props.settings.quick&&(props.settings.quick=[]);for(let i=0;i<props.settings.quick.length;i++)props.settings.quick[i]=this.validateSetting(props.settings.quick[i]),props.settings.quick[i]||props.settings.quick.splice(i,1);void 0===props.settings.configure&&(props.settings.configure=[]);for(let i=0;i<props.settings.configure.length;i++)props.settings.configure[i]=this.validateSetting(props.settings.configure[i]),props.settings.configure[i]||props.settings.configure.splice(i,1);void 0===props.settings.advanced&&(props.settings.advanced=[]);for(let i=0;i<props.settings.advanced.length;i++)props.settings.advanced[i]=this.validateSetting(props.settings.advanced[i]),props.settings.advanced[i]||props.settings.advanced.splice(i,1);props=this.standardAdvancedProps(props)}void 0===props.saveOptions&&(props.saveOptions={wipeSlot:!1}),void 0===props.demoSchema&&(props.demoSchema=[]),isReady&&this.readyToFireHAXSchema(tag,props,context),""===tag&&("function"==typeof this._setHaxProperties?this._setHaxProperties(props):this.haxProperties=props)}else console.warn("This is't a valid usage of hax API. See hax-body-behaviors/lib/HAXWiring.js for more details on how to implement the API. https://haxtheweb.org/hax-schema for details but we will try and guess the wiring")},this.readyToFireHAXSchema=(tag,props,context)=>{if(""!=tag&&void 0===window.HaxStore){const evt=new CustomEvent("hax-register-properties",{bubbles:!0,composed:!0,cancelable:!0,detail:{tag:tag.toLowerCase(),properties:props,polymer:!1}});context.dispatchEvent(evt)}else if(""!=tag){const evt=new CustomEvent("hax-register-properties",{bubbles:!0,composed:!0,cancelable:!0,detail:{tag:tag.toLowerCase(),properties:props}});context.dispatchEvent(evt)}else if(void 0!==this.tagName){const evt=new CustomEvent("hax-register-properties",{bubbles:!0,composed:!0,cancelable:!0,detail:{tag:this.tagName.toLowerCase(),properties:props}});context.dispatchEvent(evt)}else console.warn(`${tag} missed our checks and has an issue in implementation with HAX`)},this.standardAdvancedProps=props=>(props.settings.advanced.push({attribute:"class",title:"Classes",description:"CSS classes applied manually to the element",inputMethod:"textfield"}),props.settings.advanced.push({attribute:"style",title:"Styles",description:"Custom CSS styles as applied to the element",inputMethod:"textfield"}),props.settings.advanced.push({attribute:"prefix",title:"Schema: prefix",description:"Schema prefixes",inputMethod:"textfield"}),props.settings.advanced.push({attribute:"typeof",title:"Schema: TypeOf",description:"typeof definition for Schema usage",inputMethod:"textfield"}),props.settings.advanced.push({attribute:"property",title:"Schema: Property",description:"typeof definition for Schema usage",inputMethod:"textfield"}),props.settings.advanced.push({attribute:"resource",title:"Schema: Resource ID",description:"Schema resource identifier",inputMethod:"textfield"}),props.settings.advanced.push({attribute:"id",title:"ID",description:"element ID, only set this if you know why",inputMethod:"textfield"}),props.settings.advanced.push({attribute:"slot",title:"slot",description:"DOM slot area",inputMethod:"textfield"}),props),this.validateSetting=setting=>(void 0!==setting.property||void 0!==setting.slot||void 0!==setting.attribute)&&(void 0===setting.title&&(void 0===setting.attribute?setting.title=setting.property:setting.title=setting.attribute),void 0===setting.description&&(setting.description=""),void 0===setting.inputMethod&&(setting.inputMethod="textfield"),void 0===setting.type&&(setting.type="settings"),void 0===setting.icon&&(setting.icon="android"),void 0===setting.options&&(setting.options={}),void 0===setting.required&&(setting.required=!1),void 0===setting.disabled&&(setting.disabled=!1),void 0===setting.validation&&(setting.validation=".*"),void 0===setting.validationType&&(setting.validationType=""),void 0!==setting.slot&&(void 0===setting.slotWrapper&&(setting.slotWrapper="span"),void 0===setting.slotAttributes&&(setting.slotAttributes={})),setting),this.getHaxProperties=()=>this.haxProperties,this.getHaxJSONSchema=(type,haxProperties,target=this)=>{void 0===type&&(type="configure"),void 0===haxProperties&&(haxProperties=target.haxProperties);let settings=haxProperties.settings[type];var schema={$schema:"http://json-schema.org/schema#",title:"HAX "+type+" form schema",type:"object",properties:{}};if(schema.properties=(new SimpleFields).fieldsToSchema(settings),haxProperties.gizmo&&haxProperties.gizmo.tag&&window.customElements.get(haxProperties.gizmo.tag)){let tmp=document.createElement(haxProperties.gizmo.tag);schema="function"==typeof tmp.postProcessgetHaxJSONSchema?tmp.postProcessgetHaxJSONSchema(schema):target.postProcessgetHaxJSONSchema(schema)}else schema=target.postProcessgetHaxJSONSchema(schema);return schema},this.postProcessgetHaxJSONSchema=schema=>schema,this._getHaxJSONSchemaProperty=settings=>(new SimpleFields).fieldsToSchema(settings),this.getHaxJSONSchemaType=inputMethod=>{var method=(new SimpleFields).fieldsConversion.inputMethod[inputMethod]||(new SimpleFields).fieldsConversion;return method&&method.defaultSettings&&method.defaultSettings.type?method.defaultSettings.type:"string"},this.validHAXPropertyInputMethod=()=>Object.keys((new SimpleFields).fieldsConversion.inputMethod),this.prototypeHaxProperties=()=>({api:"1",canScale:!0,canPosition:!0,canEditSource:!1,gizmo:{title:"Tag name",description:"",icon:"icons:android",color:"purple",groups:["Content"],handles:[{type:"data",type_exclusive:!1,url:"src"}],meta:{author:"auto"}},settings:{quick:[{property:"title",title:"Title",inputMethod:"textfield",icon:"android"},{property:"primaryColor",title:"Primary color",inputMethod:"colorpicker",icon:"color"}],configure:[{slot:"",title:"Inner content",description:"The slotted content that lives inside the tag",inputMethod:"textfield",icon:"android",required:!0,validationType:"text"},{slot:"button",title:"Button content",description:"The content that can override the button",inputMethod:"textfield",icon:"android",required:!0,validationType:"text"},{property:"title",title:"Title",description:"",inputMethod:"textfield",icon:"android",required:!0,validationType:"text"},{property:"primaryColor",title:"Title",description:"",inputMethod:"textfield",icon:"android",required:!1,validation:".*",validationType:"text"}],advanced:[{property:"secondaryColor",title:"Secondary color",description:"An optional secondary color used in certain edge cases.",inputMethod:"colorpicker",icon:"color"},{property:"endPoint",title:"API endpoint",description:"An optional endpoint to hit and load in more data dymaically.",inputMethod:"textfield",icon:"android",validation:"[a-z0-9]",validationType:"url"}]},saveOptions:{wipeSlot:!1,unsetAttributes:["end-point","secondary-color"]},demoSchema:[{tag:"my-tag",content:"<p>inner html</p>",properties:{endPoint:"https://cdn2.thecatapi.com/images/9j5.jpg",primaryColor:"yellow",title:"A cat"}}]})}}export const HAXElement=function(SuperClass){return class extends SuperClass{constructor(){super(),this.HAXWiring=new HAXWiring}static get properties(){return{...super.properties,haxProperties:window.HAXWiring.haxProperties}}setHaxProperties(props,tag="",context=this){return""==tag&&void 0!==this.tagName&&(tag=this.tagName.toLowerCase()),window.addEventListener("hax-store-ready",this._haxStoreReady.bind(this)),void 0!==window.HaxStore&&null!=window.HaxStore.instance&&window.HaxStore.ready?this.HAXWiring.setHaxProperties(props,tag,context,!0):this.HAXWiring.setHaxProperties(props,tag,context,!1)}disconnectedCallback(){window.removeEventListener("hax-store-ready",this._haxStoreReady.bind(this)),super.disconnectedCallback&&super.disconnectedCallback()}setup(props,tag="",context=this){return this.HAXWiring.setup(props,"",this)}_haxStoreReady(e){return this.HAXWiring._haxStoreReady(e)}validateSetting(setting){return this.HAXWiring.validateSetting(setting)}getHaxProperties(){return this.haxProperties}getHaxJSONSchema(type,haxProperties,target=this){return this.HAXWiring.getHaxJSONSchema(type,haxProperties,target)}postProcessgetHaxJSONSchema(schema){return this.HAXWiring.postProcessgetHaxJSONSchema(schema)}_getHaxJSONSchemaProperty(settings){return(new SimpleFields).fieldsToSchema(settings)}getHaxJSONSchemaType(inputMethod){return this.HAXWiring.getHaxJSONSchemaType(inputMethod)}validHAXPropertyInputMethod(){return this.HAXWiring.validHAXPropertyInputMethod()}prototypeHaxProperties(){return this.HAXWiring.prototypeHaxProperties()}}};window.HAXWiring=new HAXWiring,window.HAXBehaviors=window.HAXBehaviors||{},window.HAXBehaviors.PropertiesBehaviors={properties:{haxProperties:window.HAXWiring.haxProperties},setHaxProperties:function(props,tag="",context=this){return""==tag&&void 0!==this.tagName&&(tag=this.tagName.toLowerCase()),window.addEventListener("hax-store-ready",this._haxStoreReady.bind(this)),void 0!==window.HaxStore&&null!=window.HaxStore.instance&&window.HaxStore.ready?window.HAXWiring.setHaxProperties(props,tag,context,!0):window.HAXWiring.setHaxProperties(props,tag,context,!1)},_haxStoreReady:function(e){return window.HAXWiring._haxStoreReady(e)},validateSetting:function(setting){return window.HAXWiring.validateSetting(setting)},getHaxProperties:function(){return this.haxProperties},getHaxJSONSchema:function(type,haxProperties,target=this){return window.HAXWiring.getHaxJSONSchema(type,haxProperties,target)},postProcessgetHaxJSONSchema:function(schema){return window.HAXWiring.postProcessgetHaxJSONSchema(schema)},_getHaxJSONSchemaProperty:function(settings){return(new SimpleFields).fieldsToSchema(settings)},getHaxJSONSchemaType:function(inputMethod){return window.HAXWiring.getHaxJSONSchemaType(inputMethod)},validHAXPropertyInputMethod:function(){return window.HAXWiring.validHAXPropertyInputMethod()},prototypeHaxProperties:function(){return window.HAXWiring.prototypeHaxProperties()}};